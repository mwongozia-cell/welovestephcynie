{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="mx-auto" style="max-width: 500px;">
        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body text-center">
                <h2 class="mb-3">üì£ Send a Shoutout</h2>
                <p class="text-muted">Leave a message, memory, or birthday wish for Stephcynie. You can also upload a
                    photo or video!</p>

                <form method="post" enctype="multipart/form-data" action="{% url 'messageboard:shoutout_board' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="code" class="form-label fw-semibold">RSVP Code</label>
                        <input type="text" name="code" id="code" class="form-control rounded-pill"
                            placeholder="Enter your invite code" required>
                    </div>

                    <div class="mb-3">
                        <label for="name" class="form-label fw-semibold">Your Name</label>
                        <input type="text" name="name" id="name" class="form-control rounded-pill"
                            placeholder="e.g. Amina" required>
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label fw-semibold">Message</label>
                        <textarea name="message" id="message" class="form-control rounded-4" rows="4"
                            placeholder="Write something heartfelt..." required></textarea>

                        <div class="d-flex justify-content-end mt-2">
                            <!-- Hidden Media Input -->
                            <input type="file" name="media" id="media" accept="image/*,video/*" multiple class="d-none">

                            <!-- Media Icon Button -->
                            <button type="button" id="mediaTrigger" class="btn rounded-circle border-0"
                                title="Upload Media" style="background-color: transparent;">
                                <i class="bi bi-image" style="font-size: 1.5rem; color: var(--silver);"></i>
                            </button>
                        </div>

                        <small class="text-muted d-block mt-1"><span id="charCount">0</span>/280 characters</small>
                    </div>

                    <!-- Previews -->
                    <div id="mediaPreview" class="mt-3 d-flex flex-wrap gap-3"></div>

                    <button type="submit" class="btn w-100 rounded-pill fw-bold py-2"
                        style="background-color: var(--plum); color: white;">
                        üöÄ Post Shoutout
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button id="fab" class="btn btn-primary rounded-circle shadow"
    style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 24px;">
    ‚úçÔ∏è
</button>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Script -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const mediaInput = document.getElementById("media");
        const previewContainer = document.getElementById("mediaPreview");
        const charCount = document.getElementById("charCount");
        const messageInput = document.getElementById("message");

        const selectedFiles = [];

        messageInput.addEventListener("input", () => {
            charCount.textContent = messageInput.value.length;
        });

        document.getElementById("mediaTrigger").addEventListener("click", () => {
            mediaInput.click();
        });

        mediaInput.addEventListener("change", function () {
            Array.from(this.files).forEach(file => {
                selectedFiles.push(file);
                renderPreview(file);
            });

            updateInputFiles();
            this.value = ""; // allow re-adding same file
        });

        function renderPreview(file) {
            const wrapper = document.createElement("div");
            wrapper.className = "position-relative";
            wrapper.style.maxWidth = "200px";

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.innerHTML = "&times;";
            removeBtn.className = "btn btn-sm position-absolute top-0 end-0 rounded-circle";
            removeBtn.style.backgroundColor = "transparent";
            removeBtn.style.border = "none";
            removeBtn.style.color = "var(--charcoal)";
            removeBtn.title = "Remove";

            removeBtn.addEventListener("click", () => {
                const index = selectedFiles.indexOf(file);
                if (index !== -1) selectedFiles.splice(index, 1);
                updateInputFiles();
                wrapper.remove();
            });

            if (file.type.startsWith("image/")) {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "img-fluid rounded";
                img.style.maxHeight = "200px";
                wrapper.appendChild(img);
            } else if (file.type.startsWith("video/")) {
                const video = document.createElement("video");
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.className = "w-100 rounded";
                video.style.maxHeight = "240px";
                wrapper.appendChild(video);
            }

            wrapper.appendChild(removeBtn);
            previewContainer.appendChild(wrapper);
        }

        function updateInputFiles() {
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            mediaInput.files = dt.files;
        }

        document.getElementById("fab").addEventListener("click", () => {
            document.querySelector("form").scrollIntoView({ behavior: "smooth" });
        });
    });
</script>
{% endblock %}